<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Test Machine Order Detail" default-menu-index="1">

    <parameter name="testMachineOrderId" required="true"/>

    <transition name="editParty">
        <default-response url="//${appRoot}/Party/EditParty"/>
    </transition>
    <transition name="editSupplier">
        <default-response url="//${appRoot}/Supplier/EditSupplier"/>
    </transition>
    <transition name="editCustomer">
        <default-response url="//${appRoot}/Customer/EditCustomer"/>
    </transition>

    <transition name="editFacility">
        <default-response url="//${appRoot}/Facility/EditFacility"/>
    </transition>
    <transition name="editProduct">
        <default-response url="//${appRoot}/Product/EditProduct"/>
    </transition>
    <transition name="assetDetail">
        <default-response url="//${appRoot}/Asset/AssetDetail"/>
    </transition>

    <transition name="editInvoice">
        <default-response url="//${appRoot}/Accounting/Invoice/EditInvoice"/>
    </transition>
    <transition name="editPayment">
        <default-response url="//${appRoot}/Accounting/Payment/EditPayment"/>
    </transition>
    <transition name="editPaymentMethod">
        <default-response url="//${appRoot}/Party/PaymentMethod/EditPaymentMethod"/>
    </transition>


    <transition name="updateOrderHeader">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#TestMachineOrderHeader"/>
        <default-response url="."/>
    </transition>
    <!--
        <transition name="updateOrderRecur">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderRecur"/>
            <default-response url="."/>
        </transition>
    -->

    <!--    <transition name="requestOrder">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderStatus"
                          in-map="[testMachineOrderId:testMachineOrderId, statusId:'OrderRequested']"/>
            <default-response url="."/>
        </transition>-->
    <!--    <transition name="proposeOrder">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderStatus"
                          in-map="[testMachineOrderId:testMachineOrderId, statusId:'OrderProposed']"/>
            <default-response url="."/>
        </transition>-->
    <!-- TODO: consider using cancel#TestMachineOrder service with parameter to reject instead of cancel, but rejected should always happen before Approved so nothing should be shipped, unless the order goes backward through statuses... -->
    <transition name="rejectOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#TestMachineOrderStatus"
                      in-map="[testMachineOrderId:testMachineOrderId,  statusId:'TMOHSRejected']"/>
        <default-response url="."/>
    </transition>
    <transition name="unapprovedOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#TestMachineOrderStatus"
                      in-map="[testMachineOrderId:testMachineOrderId,  statusId:'TMOHSConfirmed']"/>
        <default-response url="."/>
    </transition>

    <transition name="placeOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.place#TestMachineOrder"
                      in-map="context + [requireInventory:false]"/>
        <default-response url="."/>
    </transition>
    <transition name="approveOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.approve#TestMachineOrder"/>
        <default-response url="."/>
    </transition>
<!--    <transition name="sendOrder">-->
<!--        <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#TestMachineOrderStatus"-->
<!--                      in-map="[testMachineOrderId:testMachineOrderId, statusId:'OrderSent']"/>-->
<!--        <default-response url="."/>-->
<!--    </transition>-->
    <!--    <transition name="holdOrder">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderStatus"
                          in-map="[testMachineOrderId:testMachineOrderId, statusId:'OrderHold']"/>
            <default-response url="."/>
        </transition>-->

    <transition name="completeOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.complete#TestMachineOrder"/>
        <default-response url="."/>
    </transition>
    <transition name="cancelOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.cancel#TestMachineOrder"/>
        <default-response url="."/>
    </transition>

    <transition name="deleteOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.delete#TestMachineOrder"/>
        <default-response url="../FindTestMachineOrder"/>
    </transition>

    <transition name="cloneOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.clone#TestMachineOrder"/>
        <default-response url="."/>
    </transition>


    <!--    <transition name="recalcOrderPartItemAmounts">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.recalc#OrderPartItemAmounts"/>
            <default-response url="."/>
        </transition>-->


    <transition name="shipOrderPart">
        <service-call name="mantle.shipment.ShipmentServices.create#OrderPartShipment"/>
        <default-response url="."/>
    </transition>
    <transition name="addOrderPartToShipment">
        <service-call name="mantle.shipment.ShipmentServices.add#OrderPartToShipment"/>
        <default-response url="."/>
    </transition>
    <transition name="shipmentDetail">
        <default-response url="//${appRoot}/Shipment/ShipmentDetail"/>
    </transition>

    <transition name="createNote">
        <service-call name="create#beiyelin.testmachine.TestMachineOrderNote"/>
        <default-response url="."/>
    </transition>
    <transition name="updateNote">
        <service-call name="update#beiyelin.testmachine.TestMachineOrderNote"/>
        <default-response url="."/>
    </transition>

    <!--
        <transition name="createContent">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.create#OrderContent"/>
            <default-response url="."/>
        </transition>
        <transition name="updateContent">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderContent"/>
            <default-response url="."/>
        </transition>
        <transition name="downloadContent" read-only="true">
            <parameter name="orderContentId"/>
            <actions>
                <entity-find-one entity-name="mantle.order.OrderContent" value-field="orderContent"/>
                <script>ec.web.sendResourceResponse(orderContent.contentLocation)</script>
            </actions>
            <default-response type="none"/>
        </transition>
    -->

    <transition name="setOrderBillingShippingInfo">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.set#OrderBillingShippingInfo"/>
        <default-response url="."/>
    </transition>
    <transition name="validateAddress">
        <service-call name="mantle.shipment.CarrierServices.validate#PostalAddress"/>
        <default-response url="."/>
    </transition>

    <!--    <transition name="createOrderPart">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.create#OrderPart"/>
            <default-response url="."/>
        </transition>
        <transition name="updateOrderPart">
            <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#OrderPart"/>
            <default-response url="."/>
        </transition>-->

    <transition name="addOrderPartPayment">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.add#OrderPartPayment"/>
        <default-response url="."/>
    </transition>
    <transition name="updatePayment">
        <service-call name="mantle.account.PaymentServices.update#Payment"/>
        <default-response url="."/>
    </transition>
    <transition name="gatewayAuthorize">
        <service-call name="mantle.account.PaymentServices.authorize#SinglePayment"/>
        <default-response url="."/>
    </transition>

    <transition name="createReturnFromOrder">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.create#ReturnFromOrder"/>
        <default-response url="."/>
    </transition>
    <transition name="editReturn">
        <default-response url="component://TestMachineMgnt/screen/TestMachineReturn/EditReturn.xml"/>
    </transition>

    <!--    <transition name="createOrderPartParty">
            <service-call name="create#mantle.order.OrderPartParty"/>
            <default-response url="."/>
        </transition>
        <transition name="deleteOrderPartParty">
            <service-call name="delete#mantle.order.OrderPartParty"/>
            <default-response url="."/>
        </transition>-->

    <transition name="addProductItem">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.add#TestMachineOrderItem"/>
        <default-response url="."/>
    </transition>
    <transition name="createItem">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.create#TestMachineOrderItem"/>
        <default-response url="."/>
    </transition>
    <transition name="updateItem">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.update#TestMachineOrderItem"/>
        <default-response url="."/>
    </transition>
    <transition name="deleteItem">
        <service-call name="beiyelin.testmachine.TestMachineOrderServices.delete#TestMachineOrderItem"/>
        <default-response url="."/>
    </transition>

    <transition name="removeOrderItemReservations">
        <service-call name="mantle.product.AssetServices.remove#OrderItemReservations"/>
        <default-response url="."/>
    </transition>

    <transition-include name="getSupplerOrAllOrgInternal"
                        location="component://TestMachineMgnt/screen/TestMachineApp/TestMachineOrder/FindTestMachineOrder.xml"/>
    <transition-include name="getWhFacilitiesByOwner"
                        location="component://TestMachineMgnt/screen/TestMachineApp/TestMachineOrder/FindTestMachineOrder.xml"/>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition-include name="getProductList"
                        location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getProductPrice"
                        location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getFacilityList"
                        location="component://SimpleScreens/template/facility/FacilityTransitions.xml"/>

    <transition name="getShippingOptions">
        <parameter name="testMachineOrderId"/>
        <!--        <parameter name="orderPartSeqId"/>-->
        <actions>
            <!--            //TODO 物流信息需要进一步完善-->
            <!--
                        <entity-find-one entity-name="beiyelin.testmachine.TestMachineOrderHeader" value-field="testMachineOrderHeader"/>
                        <service-call name="mantle.product.StoreServices.get#StoreShippingOptions" out-map="shipOptsOut"
                                      in-map="[productStoreId:testMachineOrderHeader.productStoreId, testMachineOrderId:testMachineOrderId, orderPartSeqId:orderPartSeqId,
                                        postalContactMechId:postalContactMechId, getRates:true]"/>
                        <script>
                            outList = []
                            for (sop in shipOptsOut.shippingOptions) outList.add([value: "${sop.carrierPartyId}:${sop.shipmentMethodEnumId}".toString(),
                                                                                  label: "${sop.description ? sop.description : (sop.carrierPartyId != '_NA_' ? (sop.carrierName + ' - ') : '') + sop.shipmentMethodDescription}${sop.shippingTotal != null ? ' ' + ec.l10n.formatCurrency(sop.shippingTotal, testMachineOrderHeader.currencyUomId) : ''}".toString()])
                            ec.web.sendJsonResponse(outList)
                        </script>
            -->
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="EmailMessage" read-only="true">
        <parameter name="emailMessageId"/>
        <actions>
            <entity-find-one entity-name="moqui.basic.email.EmailMessage" value-field="emailMessage"/>
            <script>ec.web.sendTextResponse(emailMessage?.body, "text/html", null)</script>
        </actions>
        <default-response type="none"/>
    </transition>
    <transition name="PrintOrder.pdf">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/TestMachineOrder/PrintOrder"
                          url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/>
            <parameter name="pageNoLimit" value="true"/>
            <parameter name="testMachineOrderId"/>
            <parameter name="filename" value="TestMachineOrder-${testMachineOrderId}.pdf"/>
        </default-response>
    </transition>

    <transition name="setItemLimit">
        <actions>
            <script>ec.user.setPreference('order.detail.item.limit', itemLimit)</script>
        </actions>
        <default-response url="."/>
    </transition>

    <subscreens>
        <subscreens-item name="UpdateContactInfo"
                         location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdateContactInfo.xml"/>
        <subscreens-item name="UpdatePaymentMethodInfo"
                         location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdatePaymentMethodInfo.xml"/>
    </subscreens>
    <actions>
        <set field="defaultItemLimit" from="ec.user.getPreference('order.detail.item.limit') ?: '10'"/>
        <set field="itemLimit" from="itemLimit ?: defaultItemLimit"/>
        <service-call name="beiyelin.testmachine.TestMachineOrderInfoServices.get#TestMachineOrderDisplayInfo"
                      in-map="[testMachineOrderId:testMachineOrderId, itemLimit:(itemLimit as Integer)]"
                      out-map="context"/>

        <set field="requestRole" value="SalesRepresentative"/>
        <set field="vendorRole" value="OrgInternal,Supplier,Vendor"/>
        <set field="customerRole" value="OrgInternal,Customer"/>
<!--        <entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true">-->
<!--            <econdition field-name="enumGroupEnumId" value="EngItemsProduct"/>-->
<!--        </entity-find>-->
<!--        <set field="productItemTypes" from="productItemTypeEgms*.enumId"/>-->

        <if condition="testMachineOrderHeader.statusId in ['TMOHSConfirmed']">
            <service-call name="beiyelin.testmachine.TestMachineOrderInfoServices.check#TestMachineOrderPreApprove"
                          in-map="[testMachineOrderId:testMachineOrderId]"
                          out-map="context"/>
        </if>
    </actions>
    <widgets>
        <section name="TestMachineOrderHeaderSection">
            <widgets>
                <container-row>
                    <row-col lg="6">
                        <container-row>
                            <row-col sm="6">
                                <label text="Test Machine Order #${testMachineOrderId} "  type="h5"/>
                            </row-col>
                            <!--
                                                        <row-col sm="6">
                                                            <label text="Web Order (ecommerce)"
                                                                   condition="testMachineOrderHeader?.salesChannelEnumId == 'ScWeb'" type="h4"
                                                                   style="text-success"/>
                                                        </row-col>
                            -->
                        </container-row>
                        <link url="deleteOrder" text="Delete"  btn-type="danger" icon="fa fa-trash"
                              condition="testMachineOrderHeader.statusId == 'TMOHSOpen'"
                              confirmation="Delete the Order,cannot be recovered anyway?"/>

                        <section name="PlaceSection"
                                 condition="testMachineOrderHeader.statusId in ['TMOHSApproved']">
                            <widgets>
                                <link url="placeOrder" text="Place" link-type="hidden-form" condition="!placeWarnings"
                                      style="btn-success"/>
                                <container-dialog id="PlaceOrderDialog" button-text="Place Warnings"
                                                  condition="placeWarnings" type="success">
                                    <section-iterate name="PlaceWarningsSection" list="placeWarnings"
                                                     entry="placeWarning">
                                        <widgets>
                                            <label text="${placeWarning}" type="p"/>
                                        </widgets>
                                    </section-iterate>
                                    <link url="placeOrder" text="Place Order Anyway" link-type="hidden-form"/>
                                </container-dialog>
                            </widgets>
                        </section>
                        <section name="ApproveSection"
                                 condition="testMachineOrderHeader.statusId in ['TMOHSConfirmed']">
                            <widgets>
                                <link url="approveOrder" text="Approve" link-type="hidden-form" style="btn-success"
                                      condition="!approveWarnings"/>
                                <container-dialog id="ApproveOrderDialog" button-text="Approve Warnings"
                                                  condition="approveWarnings" type="success">
                                    <section-iterate name="ApproveWarningsSection" list="approveWarnings"
                                                     entry="approveWarning">
                                        <widgets>
                                            <label text="${approveWarning}" type="p"/>
                                        </widgets>
                                    </section-iterate>
                                    <link url="approveOrder" text="Approve Order Anyway" link-type="hidden-form"  />
                                </container-dialog>
                            </widgets>
                        </section>

                        <link url="unapprovedOrder" text="Un-approve" link-type="hidden-form"
                              condition="testMachineOrderHeader.statusId == 'TMOHSApproved'"
                              confirmation="Un-approve order (change status back to Confirmed)?"/>

                        <container-dialog id="CloseOrderDialog" button-text="Close Order" type="warning"
                                          condition="testMachineOrderHeader.statusId in ['TMOHSConfirmed', 'TMOHSPlaced', 'TMOHSApproved']">
                            <!-- list of Order with Facility, Items with Item #, Quantity, Quantity Shipped, Quantity to Cancel -->
                            <section name="CloseOrder">
                                <actions>
                                    <!--
                                                                        <set field="partProductItems"
                                                                             from="orderPartInfo.partNoParentOrderItemList?.findAll({ it.itemTypeEnumId in productItemTypes })"/>
                                    -->
                                </actions>
                                <widgets>
                                    <label text="Test Machine Order ${testMachineOrderId} Facility ${ec.resource.expand('FacilityNameTemplate', null, testMachineOrderHeader.facility)}"
                                           type="h4"/>
                                    <form-list name="CloseOrderItems" list="testMachineOrderItemList" skip-form="true">
                                        <row-actions>
                                            <set field="itemQuantityNotShipped"
                                                 from="quantityNotShippedByItem.get(testMachineOrderItemSeqId) ?: 0.0"/>
                                            <set field="itemQuantityShipped"
                                                 from="(quantity?:0.0) - itemQuantityNotShipped"/>
                                        </row-actions>
                                        <field name="testMachineOrderItemSeqId">
                                            <default-field title="Item">
                                                <display/>
                                            </default-field>
                                        </field>
                                        <field name="productId">
                                            <default-field title="Product">
                                                <display-entity entity-name="mantle.product.Product"
                                                                text="ProductNameTemplate"/>
                                            </default-field>
                                        </field>
                                        <field name="quantity">
                                            <default-field>
                                                <display/>
                                            </default-field>
                                        </field>
                                        <field name="itemQuantityShipped">
                                            <default-field title="Shipped">
                                                <display/>
                                            </default-field>
                                        </field>
                                        <field name="itemQuantityNotShipped">
                                            <default-field title="To Cancel">
                                                <display style="${itemQuantityNotShipped ? 'text-danger' : ''}"/>
                                            </default-field>
                                        </field>
                                    </form-list>
                                </widgets>
                            </section>
                            <label text="OrderDetailConfirmCloseOrder" type="p"/>
                            <link url="cancelOrder" text="Close Order" link-type="hidden-form" btn-type="warning"
                                  confirmation="OrderDetailConfirmCloseOrder"/>
                        </container-dialog>


<!--                        <link url="approveOrder" text="Approve Order" link-type="hidden-form"-->
<!--                              confirmation="Approve the Order?"-->
<!--                              condition="testMachineOrderHeader.statusId == 'TMOHSConfirmed'"/>-->

                        <link url="PrintOrder.pdf" text="Order PDF"/>

                        <link url="cloneOrder" text="Clone" confirmation="Create new order based on this one?"
                              parameter-map="[baseOrderId:testMachineOrderId]"/>


                        <container-dialog id="AuditLogDialog" button-text="Audit Log" width="960">
                            <form-list name="AuditLogList" list="auditLogList" skip-form="true">
                                <entity-find entity-name="moqui.entity.EntityAuditLog" list="auditLogList">
                                    <econdition field-name="changedEntityName" operator="in"
                                                from="['beiyelin.testmachine.TestMachineOrderHeader',  'beiyelin.testmachine.TestMachineOrderItem']"/>
                                    <!-- with statusId on OrderHeader include these as well for orders: <econdition field-name="changedFieldName" operator="not-equals" value="statusId"/> -->
                                    <econdition field-name="pkPrimaryValue" from="testMachineOrderId"/>
                                    <select-field field-name="changedEntityName"/>
                                    <order-by field-name="-changedDate,pkSecondaryValue"/>
                                </entity-find>

                                <field name="changedDate">
                                    <default-field title="Date">
                                        <display/>
                                    </default-field>
                                </field>
                                <field name="changedByUserId">
                                    <default-field title="User">
                                        <display-entity text="UsernameTemplate"
                                                        entity-name="mantle.party.PersonWithUserAccount"
                                                        key-field-name="userId"/>
                                    </default-field>
                                </field>
                                <field name="pkSecondaryValue">
                                    <default-field title="Part/Item">
                                        <display/>
                                    </default-field>
                                </field>
                                <field name="changedEntityName">
                                    <default-field title="Entity">
                                        <display
                                                text="${org.moqui.util.StringUtilities.camelCaseToPretty(changedEntityName.substring(changedEntityName.lastIndexOf('.')+1))}"/>
                                    </default-field>
                                </field>
                                <field name="changedFieldName">
                                    <default-field title="Field">
                                        <display
                                                text="${org.moqui.util.StringUtilities.camelCaseToPretty(changedFieldName)}"/>
                                    </default-field>
                                </field>
                                <field name="oldValueText">
                                    <default-field title="From">
                                        <display
                                                text="${ec.entity.formatFieldString(changedEntityName, changedFieldName, oldValueText)}"/>
                                    </default-field>
                                </field>
                                <field name="newValueText">
                                    <default-field title="To">
                                        <display
                                                text="${ec.entity.formatFieldString(changedEntityName, changedFieldName, newValueText)}"/>
                                    </default-field>
                                </field>
                            </form-list>
                        </container-dialog>

<!--                        <section-iterate name="InvoiceLinks" list="invoiceIdSet" entry="invoiceId">-->
<!--                            <widgets>-->
<!--                                <link url="editInvoice" text="Invoice ${invoiceId}" link-type="anchor-button"/>-->
<!--                            </widgets>-->
<!--                        </section-iterate>-->

                        <form-single name="HeaderForm" transition="updateOrderHeader" map="testMachineOrderHeader">
                            <field name="testMachineOrderId">
                                <default-field>
                                    <hidden/>
                                </default-field>
                            </field>

                            <field name="parentOrderId">
                                <conditional-field title="Parent Order" condition="parentOrderId">
                                    <link url="." text="${parentOrderId}"
                                          parameter-map="[testMachineOrderId:parentOrderId]"
                                          link-type="anchor"/>
                                </conditional-field>
                            </field>

                            <field name="statusId">
                                <default-field title="Status">
                                    <display text="${statusItem.description}"/>
                                </default-field>
                            </field>
                            <field name="requestDate">
                                <conditional-field condition="orderEditable"  title="Request Date">
                                    <date-time/>
                                </conditional-field>
                                <default-field>

                                </default-field>
                            </field>
                            <field name="requestPartyId" >
                                <conditional-field title="Requested By" condition="orderEditable" >
                                    <drop-down allow-empty="true">
                                        <dynamic-options transition="searchPartyList" server-search="true"
                                                         min-length="0"
                                                         parameter-map="[roleTypeId:requestRole]"/>
                                    </drop-down>
                                </conditional-field>
                                <default-field  >
                                    <display />
                                </default-field>
                            </field>
<!--                            <field name="placedDate">-->
<!--                                <conditional-field condition="orderEditable" title="Placed">-->
<!--                                    <date-time/>-->
<!--                                </conditional-field>-->
<!--                                <default-field title="Placed">-->
<!--                                    <display/>-->
<!--                                </default-field>-->
<!--                            </field>-->
                            <field name="testMachineOrderName">
                                <conditional-field title="名称" condition="orderEditable">
                                    <text-line size="40"/>
                                </conditional-field>
                                <default-field >
                                    <display/>
                                </default-field>
                            </field>
                            <field name="orderRevision">
                                <default-field title="Revision">
                                    <display also-hidden="false"/>
                                </default-field>
                            </field>
                            <field name="vendorPartyId" >
<!--                                <link text="Customer &lt;span style='color:red' &gt;Requests&lt;/span&gt;" encode="false" url="../Request" link-type="anchor"/>                                -->
                                <conditional-field title="(&lt;strong&gt;* &lt;/strong &gt;)发货方" condition="orderEditable"  tooltip="至少输入发货方代码的前两位后再查找">
                                    <drop-down allow-empty="true">
<!--                                        <dynamic-options transition="getSupplerOrAllOrgInternal">-->
<!--                                        </dynamic-options>-->
                                        <dynamic-options transition="searchPartyList" server-search="true"
                                                         min-length="2" value-field="partyId"
                                                         parameter-map="[roleTypeId:vendorRole]"/>
                                    </drop-down>
                                </conditional-field>
                                <default-field  >

                                    <display />
                                </default-field>
                            </field>
                            <field name="vendorFacilityId">
                                <conditional-field title="发货仓库" condition="orderEditable">
                                    <drop-down allow-empty="true">
                                        <dynamic-options transition="getWhFacilitiesByOwner" value-field="facilityId"
                                                         label-field="label" depends-optional="true">
                                            <depends-on field="vendorPartyId"/>
                                        </dynamic-options>
                                    </drop-down>
                                </conditional-field>
                                <default-field title="发货仓库">
                                    <display/>
                                </default-field>
                            </field>
                            <field name="customerPartyId">
                                <conditional-field title="收货方" condition="orderEditable"
                                                   tooltip="至少输入收货方代码的前两位后再查找">
                                    <drop-down allow-empty="true">
                                        <dynamic-options transition="searchPartyList" server-search="true"
                                                         min-length="2" value-field="partyId"
                                                         parameter-map="[roleTypeId:customerRole]"/>
                                    </drop-down>
                                </conditional-field>
                                <default-field title="Customer">
                                    <display/>
                                </default-field>
                            </field>
                            <field name="customerFacilityId">
                                <conditional-field title="收货仓库" condition="orderEditable">
                                    <drop-down allow-empty="true">
                                        <dynamic-options transition="getWhFacilitiesByOwner" value-field="facilityId"
                                                         label-field="label" depends-optional="true">
                                            <depends-on field="customerPartyId"/>
                                        </dynamic-options>
                                    </drop-down>
                                </conditional-field>
                                <default-field title="收货仓库">
                                    <display/>
                                </default-field>
                            </field>


                            <field name="displayId">
                                <conditional-field condition="orderEditable">
                                    <text-line size="20"/>
                                </conditional-field>
                                <default-field>
                                    <display/>
                                </default-field>
                            </field>
                            <field name="externalId">
                                <conditional-field condition="orderEditable">
                                    <text-line size="20"/>
                                </conditional-field>
                                <default-field>
                                    <display/>
                                </default-field>
                            </field>
                            <field name="externalRevision">
                                <conditional-field title="Ext Rev" condition="externalRevision">
                                    <display also-hidden="false"/>
                                </conditional-field>
                            </field>
                            <field name="grandTotal">
                                <default-field title="总金额">
                                    <display currency-unit-field="currencyUomId"/>
                                </default-field>
                            </field>
                            <field name="submitButton">
                                <conditional-field condition="orderEditable" title="Update Header">
                                    <submit/>
                                </conditional-field>
                                <default-field>
                                    <ignored/>
                                </default-field>
                            </field>
                            <field-layout>
                                <field-ref name="parentOrderId"/>
                                <field-row>
                                    <field-ref name="statusId"/>
                                    <field-ref name="orderRevision"/>
                                </field-row>
                                <field-row>
                                    <field-ref name="requestDate"/>
                                    <field-ref name="requestPartyId"/>
                                </field-row>

                                <field-ref name="testMachineOrderName"/>
                                <!--                                <field-row>

                                                                    <field-ref name="systemMessageRemoteId"/>
                                                                </field-row>-->
                                <field-row>
                                    <field-ref name="vendorPartyId"/>
                                    <field-ref name="vendorFacilityId"/>

                                </field-row>
                                <field-row>
                                    <field-ref name="customerPartyId"/>
                                    <field-ref name="customerFacilityId"/>
                                </field-row>

                                <field-row>
                                    <field-ref name="displayId"/>

                                </field-row>
                                <field-row>
                                    <field-ref name="externalId"/>
                                    <field-ref name="externalRevision"/>
                                </field-row>
                                <field-row>
                                    <field-ref name="grandTotal"/>

                                </field-row>


                                <field-ref name="submitButton"/>
                            </field-layout>
                        </form-single>


                    </row-col>
                    <row-col lg="6">
                        <section name="ItemLimitSection" condition="orderItemNoParentCount &gt; 10">
                            <widgets>
                                <form-single name="ItemLimitForm" transition="setItemLimit">
                                    <field name="testMachineOrderId">
                                        <default-field>
                                            <hidden/>
                                        </default-field>
                                    </field>
                                    <field name="itemLimit">
                                        <default-field>
                                            <drop-down>
                                                <option key="10"/>
                                                <option key="20"/>
                                                <option key="50"/>
                                                <option key="100"/>
                                            </drop-down>
                                        </default-field>
                                    </field>
                                    <field name="submitBtn">
                                        <default-field title="Update">
                                            <submit/>
                                        </default-field>
                                    </field>
                                    <field-layout>
                                        <field-row-big>
                                            <field-ref name="itemLimit"/>
                                            <field-ref name="submitBtn"/>
                                        </field-row-big>
                                    </field-layout>
                                </form-single>
                            </widgets>
                        </section>

                        <section-include name="StatusHistorySection"
                                         location="component://SimpleScreens/template/basic/StatusWidgets.xml"/>

                        <section name="CustomerNotesSection">
                            <actions>
                                <entity-find entity-name="mantle.party.PartyNote" list="customerNoteList">
                                    <econdition field-name="partyId" from="customerPartyId"/>
                                    <order-by field-name="-noteDate"/>
                                </entity-find>
                            </actions>
                            <widgets>
                                <section name="CustomerNotesInner" condition="customerNoteList">
                                    <widgets>
                                        <container-box type="danger">
                                            <box-header title="Customer Notes"/>
                                            <box-body>
                                                <section-iterate name="CustomerNoteIterate" list="customerNoteList"
                                                                 entry="partyNote">
                                                    <actions>
                                                        <entity-find-one
                                                                entity-name="mantle.party.PersonWithUserAccount"
                                                                value-field="paua">
                                                            <field-map field-name="userId" from="partyNote.userId"/>
                                                        </entity-find-one>
                                                    </actions>
                                                    <widgets>
                                                        <label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: partyNote.userId}) at ${ec.l10n.format(partyNote.noteDate, 'yyyy-MM-dd HH:mm')}"
                                                               type="strong"/>
                                                        <label text="${partyNote.noteText}" type="p"/>
                                                    </widgets>
                                                </section-iterate>
                                            </box-body>
                                        </container-box>
                                    </widgets>
                                </section>
                            </widgets>
                        </section>

                        <section name="NotesSection">
                            <widgets>
                                <container-box>
                                    <box-header title="Notes"/>
                                    <box-toolbar>
                                        <container-dialog id="NewNoteDialog" button-text="Add Note">
                                            <form-single name="NewNoteForm" transition="createNote">
                                                <field name="testMachineOrderId">
                                                    <default-field>
                                                        <hidden/>
                                                    </default-field>
                                                </field>
                                                <field name="noteText">
                                                    <default-field title="Note">
                                                        <text-area cols="60" rows="6"/>
                                                    </default-field>
                                                </field>
                                                <field name="submitButton">
                                                    <default-field title="Add Note">
                                                        <submit/>
                                                    </default-field>
                                                </field>
                                            </form-single>
                                        </container-dialog>
                                    </box-toolbar>
                                    <box-body>
                                        <section-iterate name="NoteIterateSection" list="orderNoteList" entry="note">
                                            <actions>
                                                <entity-find-one entity-name="mantle.party.PersonWithUserAccount"
                                                                 value-field="paua">
                                                    <field-map field-name="userId" from="note.userId"/>
                                                </entity-find-one>
                                            </actions>
                                            <widgets>
                                                <label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: note.userId}) at ${ec.l10n.format(note.noteDate, 'yyyy-MM-dd HH:mm')}"
                                                       type="strong"/>
                                                <section name="UpdateNoteSection"
                                                         condition="note.userId == ec.user.userId">
                                                    <widgets>
                                                        <container-dialog id="UpdateNoteContainer"
                                                                          button-text="Edit Note">
                                                            <form-single name="UpdateNoteForm" transition="updateNote"
                                                                         map="note">
                                                                <field name="testMachineOrderId">
                                                                    <default-field>
                                                                        <hidden/>
                                                                    </default-field>
                                                                </field>
                                                                <field name="noteDate">
                                                                    <default-field>
                                                                        <hidden/>
                                                                    </default-field>
                                                                </field>
                                                                <field name="noteText">
                                                                    <default-field title="Note">
                                                                        <text-area cols="60" rows="6"/>
                                                                    </default-field>
                                                                </field>
                                                                <field name="submitButton">
                                                                    <default-field title="Update">
                                                                        <submit/>
                                                                    </default-field>
                                                                </field>
                                                            </form-single>
                                                        </container-dialog>
                                                    </widgets>
                                                </section>
                                                <label text="${note.noteText}" type="p"/>
                                            </widgets>
                                        </section-iterate>
                                    </box-body>
                                </container-box>
                            </widgets>
                        </section>


                        <section name="ChildOrders" condition="childOrderList">
                            <widgets>
                                <container-box>
                                    <box-header title="Child/Cloned Orders"/>
                                    <box-body>
                                        <form-list name="ChildOrderList" list="childOrderList" skip-form="true">
                                            <field name="testMachineOrderId">
                                                <default-field title="Order">
                                                    <link url="." text="${testMachineOrderId}" link-type="anchor"/>
                                                </default-field>
                                            </field>
                                            <field name="statusId">
                                                <default-field title="Status">
                                                    <display-entity entity-name="moqui.basic.StatusItem"/>
                                                </default-field>
                                            </field>
                                            <field name="requestDate">
                                                <default-field>
                                                    <display/>
                                                </default-field>
                                            </field>
                                            <field name="approvedDate">
                                                <default-field title="Approved">
                                                    <display/>
                                                </default-field>
                                            </field>
                                            <field name="grandTotal">
                                                <default-field title="Total">
                                                    <display format="#,##0.00"/>
                                                </default-field>
                                            </field>
                                        </form-list>
                                    </box-body>
                                </container-box>
                            </widgets>
                        </section>
                    </row-col>
                </container-row>
            </widgets>
        </section>
        <section name="TestmachineOrderItemSection">
            <widgets>
                <container-box>
                    <box-header title="Order Items"/>
                    <box-toolbar>
                        <container-dialog id="AddProductItemContainer" button-text="Add Product Item" type="primary"
                                          condition="orderEditable">
                            <form-single name="AddProductItemForm" transition="addProductItem" focus-field="productId">
                                <field name="testMachineOrderId">
                                    <default-field>
                                        <hidden/>
                                    </default-field>
                                </field>
<!--                                <field name="updateExisting">-->
<!--                                    <default-field>-->
<!--                                        <hidden default-value="false"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="requireInventory">-->
<!--                                    <default-field>-->
<!--                                        <hidden default-value="false"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="assetClassEnumId">-->
<!--                                    <default-field title="Asset Class">-->

<!--                                        <drop-down allow-empty="true" no-current-selected-key="AsClsInventoryFin">-->
<!--                                            <entity-options key="${enumId}" text="${description}">-->
<!--                                                <entity-find entity-name="moqui.basic.Enumeration">-->
<!--                                                    <econdition field-name="parentEnumId" value="AsClsInventory"/>-->
<!--                                                    <order-by field-name="sequenceNum,description"/>-->
<!--                                                </entity-find>-->
<!--                                            </entity-options>-->
<!--                                        </drop-down>-->
<!--                                    </default-field>-->
<!--                                </field>-->
                                <field name="productId">
                                    <default-field title="Product" tooltip="至少输入两个字符">
                                        <drop-down>
                                            <dynamic-options transition="getProductList" server-search="true"
                                                             min-length="2"
                                                             parameter-map="[productTypeEnumId:'PtAsset']">

                                            </dynamic-options>
                                        </drop-down>
                                    </default-field>
                                </field>
                                <field name="itemDescription">
                                    <default-field title="Item Description">
                                    </default-field>
                                </field>

                                <field name="quantity">
                                    <default-field>
                                        <text-line size="8" default-value="1"/>
                                    </default-field>
                                </field>
                                <field name="unitPrice">
                                    <default-field title="Price" tooltip="Leave empty to use Calc Price">
                                        <text-line size="10"/>
                                    </default-field>
                                </field>
                                <field name="updateExisting">
                                    <default-field title="是否合并到已录入产品">

                                        <radio no-current-selected-key="false">
                                            <option key="true" text="Y"/>
                                            <option key="false" text="N"/>
                                        </radio>
                                    </default-field>
                                </field>
                                <field name="requireInventory">
                                    <default-field title="是否核查有效库存" >
                                        <radio no-current-selected-key="false">
                                            <option key="true" text="Y"/>
                                            <option key="false" text="N"/>
                                        </radio>
                                    </default-field>
                                </field>



                                <field name="submitButton">
                                    <default-field title="Add">
                                        <submit/>
                                    </default-field>
                                </field>
                                <field-layout>
                                    <field-ref name="productId"/>
                                    <field-ref name="itemDescription"/>
                                    <field-row>
                                        <field-ref name="quantity"/>
                                        <field-ref name="unitPrice"/>
                                    </field-row>
                                    <field-row>
                                        <field-ref name="updateExisting"/>
                                        <field-ref name="requireInventory"/>
                                    </field-row>
                                    <field-ref name="submitButton" />

                                </field-layout>
                            </form-single>
                        </container-dialog>
<!--                        <container-dialog id="AddOtherItemContainer" button-text="Add Other Item"-->
<!--                                          condition="orderEditable">-->
<!--                            <form-single name="AddOtherItemForm" transition="createItem" focus-field="itemTypeEnumId">-->
<!--                                <field name="testMachineOrderId">-->
<!--                                    <default-field>-->
<!--                                        <hidden/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="requireInventory">-->
<!--                                    <default-field>-->
<!--                                        <hidden default-value="false"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->

<!--                                <field name="itemTypeEnumId">-->
<!--                                    <default-field title="Item Type">-->
<!--                                        <drop-down no-current-selected-key="ItemShipping">-->
<!--                                            <entity-options key="${enumId}" text="${description}">-->
<!--                                                <entity-find entity-name="moqui.basic.EnumAndGroup"-->
<!--                                                             list="itemTypeEnumList">-->
<!--                                                    <econdition field-name="enumGroupEnumId"-->
<!--                                                                from="isCustomerInternalOrg ? 'EngItemsPurchase' : 'EngItemsSales'"/>-->
<!--                                                    <order-by field-name="description"/>-->
<!--                                                </entity-find>-->
<!--                                            </entity-options>-->
<!--                                        </drop-down>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="itemDescription">-->
<!--                                    <default-field title="Description">-->
<!--                                        <text-line size="60"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="quantity">-->
<!--                                    <default-field>-->
<!--                                        <text-line size="8" default-value="1"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="unitPrice">-->
<!--                                    <default-field title="Price">-->
<!--                                        <text-line size="10"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                                <field name="requiredByDate">-->
<!--                                    <default-field>-->
<!--                                        <date-time format="yyyy-MM-dd HH:mm"/>-->
<!--                                    </default-field>-->
<!--                                </field>-->

<!--                                <field name="submitButton">-->
<!--                                    <default-field title="Add">-->
<!--                                        <submit/>-->
<!--                                    </default-field>-->
<!--                                </field>-->
<!--                            </form-single>-->
<!--                        </container-dialog>-->
                    </box-toolbar>
                    <box-body>

                        <container type="hr"/>
                        <form-list name="TestMachineOrderItems" list="testMachineOrderItemList" list-entry="testMachineOrderItem"
                                   transition="updateItem">
<!--                        <form-list name="TestMachineOrderItems" list="testMachineOrderItemList" list-entry="testMachineOrderItem">-->

                            <row-actions>
                                <!--
                                                                <service-call name="beiyelin.testmachine.TestMachineOrderServices.get#TestMachineOrderItemTotal"
                                                                              in-map="[testMachineOrderItem:testMachineOrderItem, getChildrenTotals:true]"
                                                                              out-map="orderItemTotalOut"/>
                                -->

                                <set field="product" from="testMachineOrderItem.product"/>
                                <if condition="product != null">
                                    <entity-find entity-name="mantle.product.issuance.AssetReservation"
                                                 list="existingResList">
                                        <econdition field-name="testMachineOrderId"/>
                                        <econdition field-name="testMachineOrderItemSeqId"/>
                                    </entity-find>
                                    <set field="resInfoList" from="[]"/>
                                    <set field="lotIdSet" from="new LinkedHashSet()"/>
                                    <set field="oldestLotExpire" from="null"/>
                                    <iterate list="existingResList" entry="existingRes">
                                        <entity-find-one entity-name="mantle.product.asset.AssetLotAndMfgParty"
                                                         value-field="assetLot">
                                            <field-map field-name="assetId" from="existingRes.assetId"/>
                                            <select-field
                                                    field-name="productId,lotId,pseudoId,lotNumber,manufacturedDate,expirationDate"/>
                                        </entity-find-one>
                                        <script><![CDATA[
                                            if (assetLot?.lotId) lotIdSet.add(assetLot.lotId)
                                            if (assetLot?.expirationDate != null && (oldestLotExpire == null || assetLot.expirationDate < oldestLotExpire))
                                                oldestLotExpire = assetLot.expirationDate
                                            resInfoList.add([existingRes: existingRes, assetLot: assetLot])
                                            ]]></script>
                                    </iterate>
                                </if>

                                <!-- returnable quantities and ReturnItems -->
                                <service-call
                                        name="beiyelin.testmachine.TestMachineReturnServices.calculate#TestMachineOrderItemReturnable"
                                        out-map="returnableOut"
                                        in-map="[testMachineOrderId:testMachineOrderId, testMachineOrderItemSeqId:testMachineOrderItem.testMachineOrderItemSeqId,
                                        orderItemBillingList:orderItemBillingList, returnItemList:returnItemList]"/>
                                <set field="returnIdSet" from="new TreeSet()"/>
                                <iterate list="returnItemList" entry="returnItem">
                                    <if condition="returnItem.testMachineOrderItemSeqId != testMachineOrderItem.testMachineOrderItemSeqId">
                                        <continue/>
                                    </if>
                                    <script>returnIdSet.add(returnItem.returnId)</script>
                                </iterate>

                                <!-- item quantity and unitPrice EntityAuditLog records -->
                                <set field="itemQuantityAuditList" from="[]"/>
                                <set field="itemUnitPriceAuditList" from="[]"/>
                                <iterate list="allItemsAuditLogList" entry="auditLog">
                                    <if condition="auditLog.pkSecondaryValue != testMachineOrderItem.testMachineOrderItemSeqId">
                                        <continue/>
                                    </if>
                                    <entity-find-one entity-name="mantle.party.PersonWithUserAccount"
                                                     value-field="userAccount">
                                        <field-map field-name="userId" from="auditLog.changedByUserId"/>
                                    </entity-find-one>
                                    <entity-find-one entity-name="moqui.basic.Enumeration"
                                                     value-field="changeReasonEnum">
                                        <field-map field-name="enumId" from="auditLog.changeReason"/>
                                    </entity-find-one>
                                    <if condition="auditLog.changedFieldName == 'quantity'">
                                        <then>
                                            <script>itemQuantityAuditList.add([auditLog: auditLog, userAccount: userAccount, changeReasonEnum: changeReasonEnum])</script>
                                        </then>
                                        <else>
                                            <script>itemUnitPriceAuditList.add([auditLog: auditLog, userAccount: userAccount, changeReasonEnum: changeReasonEnum])</script>
                                        </else>
                                    </if>
                                </iterate>

<!--                                <set field="isProductItemType"-->
<!--                                     from="testMachineOrderItem.itemTypeEnumId in productItemTypes"/>-->
                                <set field="isShippable"
                                     from="isProductItemType &amp;&amp; product != null ? product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'] : false"/>
                                <set field="itemQuantityNotShipped"
                                     from="quantityNotShippedByItem.get(testMachineOrderItemSeqId) ?: 0.0"/>
                                <set field="itemQuantityShipped"
                                     from="(testMachineOrderItem.quantity?:0.0) - itemQuantityNotShipped"/>
<!--                                <set field="itemTotalNotBilled"-->
<!--                                     from="totalNotBilledByItem.get(testMachineOrderItemSeqId) ?: 0.0"/>-->
<!--                                <set field="itemQuantityNotBilled"-->
<!--                                     from="quantityNotBilledByItem.get(testMachineOrderItemSeqId) ?: 0.0"/>-->
                                <set field="itemCanDelete"
                                     from="(!isShippable || itemQuantityNotShipped == quantity)"/>
                                 <log level="warn" message="itemCanDelete ${itemCanDelete}--> isShippable:${isShippable} quantity ${quantity} itemQuantityNotShipped ${itemQuantityNotShipped} "/>

                                <!--                        <set field="newerThanExpireDate" from="null"/>
                                                        <if condition="orderPartInfo.newerInventory &amp;&amp; orderPartInfo.orderPart.customerPartyId">
                                                            &lt;!&ndash; get most recent asset issued and lot expire date for it &ndash;&gt;
                                                            <entity-find entity-name="mantle.product.issuance.AssetIssuanceLotSummary"
                                                                         list="issuanceLotList" limit="1">
                                                                <econdition field-name="toPartyId" from="orderPartInfo.orderPart.customerPartyId"/>
                                                                <econdition field-name="productId"/>
                                                                <select-field field-name="expirationDate,expectedEndOfLife"/>
                                                                <order-by field-name="-issuedDate"/>
                                                            </entity-find>
                                                            <if condition="issuanceLotList">
                                                                <set field="newerThanExpireDate"
                                                                     from="issuanceLotList[0].expirationDate ?: issuanceLotList[0].expectedEndOfLife"/>
                                                            </if>
                                                        </if>-->
                            </row-actions>

                            <hidden-parameters>
                                <parameter name="testMachineOrderId"/>
                                <parameter name="requireInventory" value="false"/>
                            </hidden-parameters>

                            <field name="testMachineOrderItemSeqId">
                                <default-field title="Item">
                                    <display/>
                                </default-field>
                            </field>


                            <field name="productId">
                                <conditional-field condition="isProductItemType &amp;&amp; orderEditable">
                                    <drop-down>
                                        <dynamic-options transition="getProductList" server-search="true"
                                                         min-length="0"/>
                                    </drop-down>
                                </conditional-field>
                            </field>
                            <field name="productLink" from="productId">
                                <default-field title="">
                                    <link url="editProduct" text="ProductNameTemplate"
                                          entity-name="mantle.product.Product"
                                          link-type="anchor" condition="productId"/>
                                </default-field>
                            </field>

                            <field name="itemDescription">
                                <conditional-field condition="orderEditable "  title="Item Description">
                                    <text-line size="30"/>
                                </conditional-field>
                                <default-field>
                                    <display/>
                                </default-field>
                            </field>
                            <field name="comments">
                                <conditional-field condition="orderEditable ">
                                    <text-line size="30"/>
                                </conditional-field>
                                <default-field>
                                    <display/>
                                </default-field>
                            </field>

                            <field name="unitListPrice">
                                <default-field title="List Price">
                                    <display currency-unit-field="testMachineOrderHeader.currencyUomId"/>
                                </default-field>
                            </field>
                            <field name="unitPrice">
                                <conditional-field condition="orderEditable ">
                                    <text-line size="8" format="#,##0.00#"/>
                                </conditional-field>
                                <default-field title="Unit Price">
                                    <display currency-unit-field="testMachineOrderHeader.currencyUomId"/>
                                </default-field>
                            </field>
                            <field name="amount" align="right">
                                <default-field title="Amount">
                                    <display currency-unit-field="testMachineOrderHeader.currencyUomId"/>
                                </default-field>
                            </field>
                            <field name="unitPriceHist">
                                <default-field title="">
                                    <render-mode>
                                        <text type="html,vuet"><![CDATA[
                        <#assign popoverContent>
                            <table style="width:100%;"><#list itemUnitPriceAuditList as auditInfo><tr>
                                <td class="text-right">${ec.l10n.formatCurrency(auditInfo.auditLog.newValueText, testMachineOrderHeader.currencyUomId, 3)}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </#assign>
                        <a role="button" data-toggle="popover" data-placement="left" data-title="${ec.resource.expand('Price History for Item ${testMachineOrderItemSeqId}', null)}" data-content="${popoverContent?html}">${ec.l10n.localize('Price History')}</a>
                    ]]></text>
                                        <text type="qvt"><![CDATA[
                        <div class="text-primary cursor-pointer">${ec.l10n.localize('Price History')}<q-tooltip>
                            <div>${ec.resource.expand('Price History for Item ${testMachineOrderItemSeqId}', null)}</div>
                            <table style="width:100%;"><#list itemUnitPriceAuditList as auditInfo><tr>
                                <td class="text-right">${ec.l10n.formatCurrency(auditInfo.auditLog.newValueText, testMachineOrderHeader.currencyUomId, 3)}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </q-tooltip></div>
                    ]]></text>
                                    </render-mode>
                                </default-field>
                            </field>
                            <field name="quantity">
                                <conditional-field condition="orderEditable">
                                    <text-line size="5"/>
                                </conditional-field>
                                <default-field>
                                    <display/>
                                </default-field>
                            </field>
                            <field name="quantityHist">
                                <default-field title="">
                                    <render-mode>
                                        <text type="html,vuet"><![CDATA[
                        <#assign popoverContent>
                            <table style="width:100%;"><#list itemQuantityAuditList as auditInfo><tr>
                                <td class="text-right">${auditInfo.auditLog.newValueText}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </#assign>
                        <a role="button" data-toggle="popover" data-placement="left" data-title="${ec.resource.expand('Quantity History for Item ${testMachineOrderItemSeqId}', null)}" data-content="${popoverContent?html}">${ec.l10n.localize('Quantity History')}</a>
                    ]]></text>
                                        <text type="qvt"><![CDATA[
                        <div class="text-primary cursor-pointer">${ec.l10n.localize('Quantity History')}<q-tooltip>
                            <div>${ec.resource.expand('Quantity History for Item ${testMachineOrderItemSeqId}', null)}</div>
                            <table style="width:100%;"><#list itemQuantityAuditList as auditInfo><tr>
                                <td class="text-right">${auditInfo.auditLog.newValueText}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </q-tooltip></div>
                    ]]></text>
                                    </render-mode>
                                </default-field>
                            </field>
                            <field name="standardCost">
                                <conditional-field
                                        condition="orderEditable &amp;&amp; isProductItemType &amp;&amp; isCustomerInternalOrg">
                                    <text-line size="10" format="#,##0.00#"/>
                                </conditional-field>
                                <default-field>
                                    <display currency-unit-field="testMachineOrderHeader.currencyUomId"/>
                                </default-field>
                            </field>

<!--                            <field name="notShippedBilled">
                                <default-field title="Not Shipped/Billed">
                                    <label text="${ec.l10n.format(itemQuantityNotShipped, '#,##0.###')} / ${ec.l10n.format(itemQuantityNotBilled, '#,##0.###')}"
                                           condition="isProductItemType" type="div"/>
                                    <label text="N/A / ${ec.l10n.format(itemTotalNotBilled, '#,##0.00')}"
                                           condition="!isProductItemType" type="div"/>
                                    <label text="Cancelled: ${quantityCancelled}" condition="quantityCancelled"
                                           type="p"/>
                                </default-field>
                            </field>-->


                            <!--
                                                        <field name="itemTotal" from="orderItemTotalOut.itemTotal" align="right">
                                                            <default-field>
                                                                <display currency-unit-field="testMachineOrderHeader.currencyUomId"/>
                                                            </default-field>
                                                        </field>
                            -->


                            <field name="submitButton"><default-field title="">

                                    <submit icon="fa fa-pencil"  confirmation="Update item ${testMachineOrderItemSeqId}?"/>
<!--
                                    <link url="updateItem"  btn-type="default" icon="fa fa-pencil"
                                          condition="itemCanDelete"
                                          confirmation="Update item ${testMachineOrderItemSeqId}?"/>
-->

                                </default-field>
                            </field>

                            <field name="deleteButton"><default-field title="">
<!--                                    <submit text="Delete"/>-->
                                    <link url="deleteItem"  btn-type="danger" icon="fa fa-trash"
                                          condition="itemCanDelete"
                                          confirmation="Delete item ${testMachineOrderItemSeqId}?"/>

                                </default-field>
                            </field>

                            <form-list-column>
                                <field-ref name="testMachineOrderItemSeqId"/>
                            </form-list-column>
                            <form-list-column>
                                <field-ref name="productId"/>
                                <field-ref name="productLink"/>
                                <field-ref name="itemDescription"/>
                            </form-list-column>
                            <form-list-column>
                                <field-ref name="quantity"/>
                                <field-ref name="quantityHist"/>
                            </form-list-column>
                            <form-list-column>
                                <field-ref name="unitPrice"/>
                                <field-ref name="amount"/>
                                <field-ref name="unitPriceHist"/>
                            </form-list-column>


                            <form-list-column>
                                <field-ref name="unitListPrice"/>
                                <!--                        <field-ref name="notShippedBilled"/>-->
                                <!--                        <field-ref name="assetReservations"/>-->
                                <field-ref name="standardCost"/>
                            </form-list-column>
                            <!--
                                                        <form-list-column>
                                                            <field-ref name="itemTotal"/>
                                                                                    <field-ref name="itemPlusChildrenTotal"/>
                                                        </form-list-column>
                            -->
                            <!--
                                                <form-list-column>
                                                    <field-ref name="returns"/>
                                                    <field-ref name="returnItem"/>
                                                </form-list-column>
                            -->
                            <form-list-column>
                                <field-ref name="comments"/>
                            </form-list-column>
                            <form-list-column>
                                <field-ref name="submitButton"/>
                                <field-ref name="deleteButton"/>
                            </form-list-column>
                        </form-list>
                        <container type="hr">
                            <label text="注：最多可输入的明细行数为${itemLimit}" type="i"/>
                        </container>
                    </box-body>
                </container-box>


            </widgets>
        </section>


        <text type="html,vuet">
            <![CDATA[<script>$(function () { $('[data-toggle="popover"]').popover({ sanitize:false, html:true, trigger:"hover click" }); })</script>]]></text>
    </widgets>
</screen>
